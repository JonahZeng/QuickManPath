name: Build and Release Windows

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [Release]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache FLTK
      id: cache-fltk
      uses: actions/cache@v3
      with:
        path: fltk_install
        key: fltk-1.4.4-windows-x64
        
    - name: Install FLTK
      if: steps.cache-fltk.outputs.cache-hit != 'true'
      run: |
        # Download and install FLTK 1.4.4
        $fltk_version = "1.4.4"
        $fltk_url = "https://github.com/fltk/fltk/releases/download/release-1.4.4/fltk-1.4.4-source.tar.gz"
        $fltk_tar = "fltk-$fltk_version-source.tar.gz"
        $fltk_dir = "fltk-$fltk_version"
        $install_dir = "fltk_install"
        
        # Download FLTK
        Write-Host "Downloading FLTK $fltk_version..."
        Invoke-WebRequest -Uri $fltk_url -OutFile $fltk_tar
        
        # Extract tar.gz on Windows
        Write-Host "Extracting FLTK..."
        # Use 7zip to extract tar.gz
        7z x $fltk_tar -so | 7z x -si -ttar
        
        # Build and install FLTK
        Write-Host "Building FLTK..."
        cd $fltk_dir
        mkdir build -Force
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_INSTALL_PREFIX="../../$install_dir" -DFLTK_BUILD_EXAMPLES=OFF -DFLTK_BUILD_TEST=OFF -DFLTK_BUILD_SHARED_LIBS=OFF
        cmake --build . --config Release --target install --parallel
        cd ../..
        
        # Clean up source files to save space
        Remove-Item -Recurse -Force $fltk_dir, $fltk_tar
        
    - name: Configure CMake
      run: |
        $env:CMAKE_PREFIX_PATH = "$PWD/fltk_install"
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        
    - name: Build
      run: |
        cmake --build build --config ${{ matrix.build_type }} --parallel
        
    - name: Verify Build
      run: |
        $exePath = "build/bin/${{ matrix.build_type }}/QuickManPath.exe"
        if (Test-Path $exePath) {
          Write-Host "✓ Build successful: $exePath"
          $fileInfo = Get-Item $exePath
          Write-Host "  Size: $($fileInfo.Length) bytes"
          Write-Host "  Created: $($fileInfo.CreationTime)"
        } else {
          Write-Error "✗ Build failed: executable not found at $exePath"
          exit 1
        }
        
    - name: Install NSIS
      if: matrix.build_type == 'Release'
      run: |
        # Install NSIS using chocolatey
        choco install nsis -y
        
    - name: Package
      if: matrix.build_type == 'Release'
      run: |
        cd build
        cpack -C Release
        
        # Check for ZIP package
        if (Test-Path "*.zip") {
          Write-Host "✓ ZIP package created successfully"
          Get-ChildItem "*.zip" | ForEach-Object { 
            Write-Host "  $($_.Name): $($_.Length) bytes"
          }
        } else {
          Write-Error "✗ ZIP package creation failed"
          exit 1
        }
        
        # Check for NSIS installer
        if (Test-Path "*.exe") {
          Write-Host "✓ NSIS installer created successfully"
          Get-ChildItem "*.exe" | ForEach-Object { 
            Write-Host "  $($_.Name): $($_.Length) bytes"
          }
        } else {
          Write-Error "✗ NSIS installer creation failed"
          exit 1
        }
        
    - name: Upload Build Artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: QuickManPath-Windows-${{ matrix.build_type }}
        path: |
          build/*.zip
          build/*.exe
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') && matrix.build_type == 'Release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.zip
          build/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Debug Symbols
      if: matrix.build_type == 'Debug'
      uses: actions/upload-artifact@v4
      with:
        name: QuickManPath-Windows-Debug-Symbols
        path: |
          build/bin/Debug/*.pdb
        retention-days: 7
